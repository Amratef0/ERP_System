@model EmployeeLeaveBalanceVM

@{
    ViewData["Title"] = "Employee Leave Balances";
}

<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col-md-12">
            <h2><i class="bi bi-calendar-check"></i> Employee Leave Balances</h2>
            <hr />
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mb-3">
        <div class="col-md-12">
            <a asp-action="Create" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Create New Balance
            </a>
            <a asp-action="GenerateBalances" class="btn btn-success">
                <i class="bi bi-gear"></i> Generate Balances
            </a>
            <a asp-action="CarryForward" class="btn btn-warning">
                <i class="bi bi-arrow-right-circle"></i> Carry Forward
            </a>
        </div>
    </div>

    <!-- Alert Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["WarningMessage"] != null)
    {
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-circle"></i> @TempData["WarningMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Filter Section -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> Filters</h5>
        </div>
        <div class="card-body">
            <form id="filterForm">
                @Html.AntiForgeryToken()
                <div class="row">
                    <div class="col-md-2">
                        <label for="yearFilter" class="form-label">Year</label>
                        <input type="number" id="yearFilter" name="year" class="form-control" 
                               value="@DateTime.Now.Year" min="2020" max="2100" />
                    </div>
                    <div class="col-md-2">
                        <label for="leaveTypeFilter" class="form-label">Leave Type</label>
                        <select id="leaveTypeFilter" name="leaveTypeId" class="form-select">
                            <option value="">All</option>
                            @foreach (var leaveType in Model.LeaveTypes ?? Enumerable.Empty<LeaveType>())
                            {
                                <option value="@leaveType.Id">@leaveType.Name</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="employeeNameFilter" class="form-label">Employee Name</label>
                        <input type="text" id="employeeNameFilter" name="employeeName" class="form-control" 
                               placeholder="Search by name..." />
                    </div>
                    <div class="col-md-2">
                        <label for="branchFilter" class="form-label">Branch</label>
                        <select id="branchFilter" name="branchId" class="form-select">
                            <option value="">All</option>
                            @foreach (var branch in Model.Branches ?? Enumerable.Empty<Branch>())
                            {
                                <option value="@branch.Id">@branch.Name</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="departmentFilter" class="form-label">Department</label>
                        <select id="departmentFilter" name="departmentId" class="form-select">
                            <option value="">All</option>
                            @foreach (var dept in Model.Departments ?? Enumerable.Empty<Department>())
                            {
                                <option value="@dept.Id">@dept.Name</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="employeeTypeFilter" class="form-label">Employee Type</label>
                        <select id="employeeTypeFilter" name="employeeTypeId" class="form-select">
                            <option value="">All</option>
                            @foreach (var type in Model.EmployeeTypes ?? Enumerable.Empty<EmployeeType>())
                            {
                                <option value="@type.Id">@type.Name</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-2">
                        <label for="jobTitleFilter" class="form-label">Job Title</label>
                        <select id="jobTitleFilter" name="jobTitleId" class="form-select">
                            <option value="">All</option>
                            @foreach (var jobTitle in Model.JobTitles ?? Enumerable.Empty<JobTitle>())
                            {
                                <option value="@jobTitle.Id">@jobTitle.Name</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" id="searchBtn" class="btn btn-primary w-100">
                            <i class="bi bi-search"></i> Search
                        </button>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" id="clearBtn" class="btn btn-secondary w-100">
                            <i class="bi bi-x-circle"></i> Clear
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Results Table -->
    <div class="card">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="bi bi-table"></i> Leave Balance Records</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="balancesTable">
                    <thead class="table-dark">
                        <tr>
                            <th>Employee Name</th>
                            <th>Leave Type</th>
                            <th>Year</th>
                            <th>Branch</th>
                            <th>Department</th>
                            <th>Job Title</th>
                            <th>Total Entitled</th>
                            <th>Used Days</th>
                            <th>Remaining</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="balancesTableBody">
                        <tr>
                            <td colspan="10" class="text-center">
                                <em>Use filters above to search for leave balances</em>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Search on form submit
            $("#filterForm").submit(function (e) {
                e.preventDefault();
                searchBalances();
            });

            // Clear filters
            $("#clearBtn").click(function () {
                $("#filterForm")[0].reset();
                $("#yearFilter").val(@DateTime.Now.Year);
                $("#balancesTableBody").html('<tr><td colspan="10" class="text-center"><em>Use filters above to search for leave balances</em></td></tr>');
            });

            function searchBalances() {
                var formData = $("#filterForm").serialize();

                $.ajax({
                    type: "POST",
                    url: '@Url.Action("Search", "EmployeeLeaveBalance")',
                    data: formData,
                    success: function (data) {
                        fillTable(data);
                    },
                    error: function (xhr, status, error) {
                        console.error("Search failed:", error);
                        alert("An error occurred while searching.");
                    }
                });
            }

            function fillTable(balances) {
                var tableBody = $("#balancesTableBody");
                tableBody.empty();
                var token = $('input[name="__RequestVerificationToken"]').val();

                if (balances && balances.length > 0) {
                    balances.forEach(function (balance) {
                        var remainingClass = balance.remainingDays < 0 ? 'text-danger fw-bold' : 
                                           balance.remainingDays < 5 ? 'text-warning fw-bold' : 
                                           'text-success';

                        var row = `<tr>
                            <td>${balance.employeeName || 'N/A'}</td>
                            <td>${balance.leaveTypeName || 'N/A'}</td>
                            <td>${balance.year}</td>
                            <td>${balance.branchName || 'N/A'}</td>
                            <td>${balance.departmentName || 'N/A'}</td>
                            <td>${balance.jobTitleName || 'N/A'}</td>
                            <td>${balance.totalEntitledDays.toFixed(2)}</td>
                            <td>${balance.usedDays.toFixed(2)}</td>
                            <td class="${remainingClass}">${balance.remainingDays.toFixed(2)}</td>
                            <td>
                                <a href="/EmployeeLeaveBalance/Details/${balance.id}" class="btn btn-sm btn-info" title="Details">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="/EmployeeLeaveBalance/Edit/${balance.id}" class="btn btn-sm btn-warning" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <form action="/EmployeeLeaveBalance/Delete/${balance.id}" method="post" style="display:inline;" 
                                      onsubmit="return confirm('Are you sure you want to delete this balance?');">
                                    <input type="hidden" name="__RequestVerificationToken" value="${token}" />
                                    <button type="submit" class="btn btn-sm btn-danger" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>`;
                        tableBody.append(row);
                    });
                } else {
                    tableBody.html('<tr><td colspan="10" class="text-center"><em>No results found</em></td></tr>');
                }
            }

            // Auto-search on page load with current year
            searchBalances();
        });
    </script>
}
