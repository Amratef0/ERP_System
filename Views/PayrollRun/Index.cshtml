@model IEnumerable<PayrollRunVM>

@{
    ViewData["Title"] = "Payroll Runs";
    var selectedYear = ViewBag.SelectedYear as int?;
    var selectedMonth = ViewBag.SelectedMonth as int?;
    var selectedIsLocked = ViewBag.SelectedIsLocked as bool?;
}

<div class="page-section">

    <!-- Header -->
    <div class="bp-header">
        <h1>Payroll Runs</h1>
        <p>Manage monthly payroll for employees</p>
    </div>

    <!-- Search / Filter Card -->
    <div class="bp-search-card shadow-sm border-0 mb-4">
        <div class="card-body p-3">
            <form method="get" asp-action="Index" class="bp-search-form row g-3 align-items-end">

                <div class="col-md-3">
                    <label class="form-label small text-muted">Year</label>
                    <select name="year" class="form-select bp-filter-select">
                        <option value="">All Years</option>
                        @for (int y = DateTime.Now.Year; y >= DateTime.Now.Year - 5; y--)
                        {
                            <option value="@y" selected="@(selectedYear == y)">@y</option>
                        }
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label small text-muted">Month</label>
                    <select name="month" class="form-select bp-filter-select">
                        <option value="">All Months</option>
                        @for (int m = 1; m <= 12; m++)
                        {
                            var monthName = new DateTime(2000, m, 1).ToString("MMMM");
                            <option value="@m" selected="@(selectedMonth == m)">@monthName</option>
                        }
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label small text-muted">Status</label>
                    <select name="isLocked" class="form-select bp-filter-select">
                        <option value="">All</option>
                        <option value="false" selected="@(selectedIsLocked == false)">Draft</option>
                        <option value="true" selected="@(selectedIsLocked == true)">Confirmed</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <button type="submit" class="btn bp-btn-filter w-100">
                        <i class="bi bi-funnel me-2"></i>Apply Filters
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- List Section -->
    <div class="list-page customers-page mt-4">

        <div class="card">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="card-title fw-semibold">Payroll List</h2>
                <span class="badge bg-primary rounded-pill">@Model.Count() Runs</span>
            </div>

            <!-- Floating Add Button -->
            <a asp-action="Create"
               class="floating-btn"
               title="Generate Payroll Run">
               <i class="fa-solid fa-plus"></i>
            </a>

            @if (Model.Any())
            {
                <table>
                    <thead>
                        <tr>
                            <th>Payroll Name</th>
                            <th>Period</th>
                            <th>Employees</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Processed</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var run in Model)
                        {
                            <tr>
                                <td data-label="Payroll Name">
                                    <strong>@run.Name</strong>
                                </td>

                                <td data-label="Period">
                                    <small class="text-muted">
                                        @run.PeriodStart.ToString("dd MMM") - @run.PeriodEnd.ToString("dd MMM yyyy")
                                    </small>
                                </td>

                                <td data-label="Employees">
                                    <span class="badge bg-secondary">@run.EmployeeCount</span>
                                </td>

                                <td data-label="Total">
                                    @if (run.CurrencyTotals.Any())
                                    {
                                        <small>
                                            @foreach (var total in run.CurrencyTotals.Take(2))
                                            {
                                                <div><strong>@total.Value.ToString("N2")</strong> @total.Key</div>
                                            }
                                            @if (run.CurrencyTotals.Count > 2)
                                            {
                                                <div class="text-muted">+@(run.CurrencyTotals.Count - 2) more...</div>
                                            }
                                        </small>
                                    }
                                    else
                                    {
                                        <span class="text-muted">N/A</span>
                                    }
                                </td>

                                <td data-label="Status">
                                    @if (run.IsLocked)
                                    {
                                        <span class="status active"><i class="bi bi-lock-fill"></i> Confirmed</span>
                                    }
                                    else
                                    {
                                        <span class="status inactive"><i class="bi bi-unlock-fill"></i> Draft</span>
                                    }
                                </td>

                                <td data-label="Processed">
                                    @if (run.ProcessedDate.HasValue)
                                    {
                                        <small>@run.ProcessedDate.Value.ToString("dd MMM yyyy HH:mm")</small>
                                    }
                                    else
                                    {
                                        <em class="text-muted">Not processed</em>
                                    }
                                </td>

                                <td data-label="Actions">
                                    <div class="action-buttons">
                                        <a asp-action="Details" asp-route-id="@run.Id" class="btn btn-view btn-sm" title="View Details">
                                            <i class="fa-solid fa-eye"></i>
                                        </a>

                                        @if (!run.IsLocked)
                                        {
                                            <form asp-action="Delete" asp-route-id="@run.Id" method="post"
                                                  style="display: inline;"
                                                  onsubmit="return confirm('Are you sure you want to delete this payroll run?');">
                                                @Html.AntiForgeryToken()
                                                <button type="submit" class="btn btn-delete btn-sm" title="Delete">
                                                <i class="fa-solid fa-trash"></i>
                                                </button>
                                            </form>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-inbox display-4 d-block mb-2"></i>
                    No payroll runs found
                </div>
            }
        </div>
    </div>



</div>

 
<link rel="stylesheet" href="~/css/ListPageHeader.css" />
<link rel="stylesheet" href="~/css/CRUD/Index.css" />
<link rel="stylesheet" href="~/css/pagination.css" />
