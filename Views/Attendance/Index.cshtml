@model AttendanceIndexVM

@{
    ViewData["Title"] = "Attendance Records";
}

<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />

<div class="page-section">
   <!-- Header Section -->
<div class="bp-header">
    <div class="bp-header-content">
        <div>
            <h2><i class="bi bi-calendar-check"></i> Attendance Records</h2>
            <p class="text-muted">Track and manage employee attendance</p>
        </div>
        <div>
            <a asp-action="MonthlyReport" class="bp-back-btn btn-lg">
                <i class="bi bi-file-earmark-bar-graph"></i> Monthly Report
            </a>
        </div>
    </div>
</div>


<!-- Calendar -->
<div class="row mb-4">
    <!-- Calendar Section -->
    <div class="col-lg-7 col-md-12 mb-4">
        <div class="calendar-card h-100">
            <div class="calendar-card-header">
                <i class="bi bi-calendar3"></i> Select Date
            </div>
            <div class="calendar-card-body">
                <div id="calendar"></div>
                
                <div class="selected-date-box mt-3">
                    <h6 class="mb-2"><i class="bi bi-calendar-check"></i> Selected Date:</h6>
                    <div id="selectedDateDisplay" class="fs-5 fw-bold text-primary">
                        No date selected
                    </div>
                </div>
            </div>
        </div>
    </div>



<!-- Filters Section - Narrower -->
<div class="col-lg-5 col-md-12 mb-4">
    <!-- Country Selection Card -->
    <div class="bp-search-card shadow-sm border-0 mb-3">
        <!-- Header -->
        <div class="p-2 mb-2" style="background-color: #28a745; color: white; border-radius: 20px;">
            <h4 class="mb-0"><i class="bi bi-globe"></i> Country Selection</h4>
        </div>

        <div class="card-body p-3">
            <label for="countryFilter" class="form-label small">
                <i class="bi bi-geo-alt"></i> Select Country <span class="text-danger">*</span>
            </label>
            <select id="countryFilter" class="form-select bp-filter-select" 
                    asp-items="@(new SelectList(Model.Countries, "Id", "Name"))">
                <option value="">-- Select Country --</option>
            </select>
        </div>
    </div>

    <!-- Additional Filters Card -->
    <div class="bp-search-card shadow-sm border-0">
        <!-- Header -->
        <div class="p-2 mb-2" style="background-color: #17a2b8; color: white; border-radius: 20px;">
            <h4 class="mb-0"><i class="bi bi-funnel"></i> Additional Filters</h4>
        </div>

        <div class="card-body p-3">
            <form id="searchForm">
                @Html.AntiForgeryToken()
                
                <!-- Search Employee -->
                <div class="mb-3">
                    <label for="searchTerm" class="form-label small">
                        <i class="bi bi-search"></i> Search Employee
                    </label>
                    <input type="text" id="searchTerm" class="form-control form-control-lg bp-filter-select" 
                           placeholder="Search by employee name..." />
                </div>

                <!-- Branch -->
                <div class="mb-3">
                    <label for="branchFilter" class="form-label small">
                        <i class="bi bi-building"></i> Branch
                    </label>
                    <select id="branchFilter" class="form-select bp-filter-select" 
                            asp-items="@(new SelectList(Model.Branches, "Id", "Name"))">
                        <option value="">-- All Branches --</option>
                    </select>
                </div>

                <!-- Department -->
                <div class="mb-3">
                    <label for="departmentFilter" class="form-label small">
                        <i class="bi bi-diagram-3"></i> Department
                    </label>
                    <select id="departmentFilter" class="form-select bp-filter-select" 
                            asp-items="@(new SelectList(Model.Departments, "Id", "Name"))">
                        <option value="">-- All Departments --</option>
                    </select>
                </div>

                <!-- Employee Type -->
                <div class="mb-3">
                    <label for="employeeTypeFilter" class="form-label small">
                        <i class="bi bi-person-lines-fill"></i> Type
                    </label>
                    <select id="employeeTypeFilter" class="form-select bp-filter-select" 
                            asp-items="@(new SelectList(Model.EmployeeTypes, "Id", "Name"))">
                        <option value="">-- All Types --</option>
                    </select>
                </div>

                <!-- Job Title -->
                <div class="mb-3">
                    <label for="jobTitleFilter" class="form-label small">
                        <i class="bi bi-briefcase"></i> Job Title
                    </label>
                    <select id="jobTitleFilter" class="form-select bp-filter-select" 
                            asp-items="@(new SelectList(Model.JobTitles, "Id", "Name"))">
                        <option value="">-- All Job Titles --</option>
                    </select>
                </div>

                <!-- Action Buttons -->
                <div class="d-flex gap-3 flex-wrap mb-4">
                    <button type="button" id="searchBtn" class="quick-action-btn card1">
                        <i class="bi bi-search me-2"></i> <span>Load Attendance</span>
                    </button>
                    <button type="button" id="clearBtn" class="quick-action-btn card3">
                        <i class="bi bi-x-circle me-2"></i> <span>Clear Filters</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>



    <!-- Alert for info messages -->
    <div class="row mb-3">
        <div class="col-12">
            <div id="infoAlert"></div>
        </div>
    </div>

<!-- Attendance Records Table -->
<div class="list-page mt-4">
    <div class="card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="card-title fw-semibold"><i class="bi bi-table"></i> Attendance Records</h2>
            <span id="recordCount" class="badge bg-primary rounded-pill fs-6">0 Records</span>
        </div>

        <!-- Floating Export Button (يمكنك تعديل لو عايزة) -->
        <button type="button" id="exportBtn" class="floating-btn" disabled title="Export to Excel">
            <i class="bi bi-download"></i>
        </button>

        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th class="text-center">#</th>
                        <th>Full Name</th>
                        <th>Branch</th>
                        <th>Department</th>
                        <th>Type</th>
                        <th>Job Title</th>
                        <th class="text-center">Status</th>
                        <th class="text-center">Check In</th>
                        <th class="text-center">Check Out</th>
                        <th class="text-center">Total Hours</th>
                        <th class="text-center">Overtime</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody id="attendanceRecords">
                    <tr>
                        <td colspan="12" class="text-center text-muted py-5">
                            <i class="bi bi-calendar-x" style="font-size: 3rem; opacity: 0.5;"></i>
                            <p class="mt-3 mb-0 fs-5">Please select a date and country to view attendance records</p>
                            <p class="text-muted"><small>Use the calendar and filters above to get started</small></p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

</div>
<link rel="stylesheet" href="~/css/ListPageHeader.css" />
<link rel="stylesheet" href="~/css/CRUD/Index.css" />
<link rel="stylesheet" href="~/css/pagination.css" />

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <!-- FullCalendar JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

    <script>
        $(document).ready(function () {
            let selectedDate = null;
            let calendar = null;

            // Initialize FullCalendar
            var calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth'
                },
                height: 'auto',
                contentHeight: 'auto',
                aspectRatio: 1.8,
                selectable: true,
                selectMirror: true,
                dateClick: function(info) {
                    // Remove previous selection styling
                    $('.fc-day').removeClass('fc-day-selected');
                    
                    // Add selection styling to clicked date
                    $(info.dayEl).addClass('fc-day-selected');
                    
                    // Store selected date
                    selectedDate = info.dateStr;
                    
                    // Update display
                    const dateObj = new Date(info.dateStr + 'T00:00:00');
                    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                    const formattedDate = dateObj.toLocaleDateString('en-US', options);
                    $('#selectedDateDisplay').html('<i class="bi bi-calendar-event me-2"></i> ' + formattedDate);
                    
                    // Auto-load if country is selected
                    const country = parseInt($("#countryFilter").val()) || 0;
                    if (country > 0) {
                        filter();
                    }
                },
                dayCellClassNames: function(arg) {
                    // Highlight today
                    if (arg.date.toDateString() === new Date().toDateString()) {
                        return ['fc-day-today-custom'];
                    }
                    return [];
                },
                validRange: {
                    start: '2020-01-01', // Allow past dates
                    end: new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString().split('T')[0] // Up to 1 year future
                }
            });
            
            calendar.render();

            // Set today as default selected date
            const today = new Date();
            selectedDate = today.toISOString().split('T')[0];
            
            // Highlight today on calendar
            setTimeout(function() {
                const todayCell = $('.fc-day[data-date="' + selectedDate + '"]');
                todayCell.addClass('fc-day-selected');
                
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const formattedDate = today.toLocaleDateString('en-US', options);
                $('#selectedDateDisplay').html('<i class="bi bi-calendar-event me-2"></i> ' + formattedDate);
            }, 100);

            function filter() {
                if (!selectedDate) {
                    $("#infoAlert").html('<div class="alert alert-warning alert-dismissible fade show">' +
                        '<i class="bi bi-exclamation-triangle"></i> Please select a date from the calendar.' +
                        '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                        '</div>');
                    return;
                }

                var searchTerm = $("#searchTerm").val();
                var country = parseInt($("#countryFilter").val()) || 0;
                var branch = parseInt($("#branchFilter").val()) || 0;
                var department = parseInt($("#departmentFilter").val()) || 0;
                var employeeType = parseInt($("#employeeTypeFilter").val()) || 0;
                var jobTitle = parseInt($("#jobTitleFilter").val()) || 0;
                var token = $('input[name="__RequestVerificationToken"]').val();

                if (country > 0) {
                    $.ajax({
                        type: "POST",
                        url: '@Url.Action("GetAttendance", "Attendance")',
                        data: {
                            date: selectedDate,
                            name: searchTerm,
                            countryId: country,
                            branchId: branch,
                            departmentId: department,
                            typeId: employeeType,
                            jobTitleId: jobTitle,
                            __RequestVerificationToken: token
                        },
                        success: function (response) {
                            fillTable(response.attendanceRecords);
                            if (response.infoMessage) {
                                $("#infoAlert").html('<div class="alert alert-info alert-dismissible fade show">' +
                                    '<i class="bi bi-info-circle"></i> ' + response.infoMessage +
                                    '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                                    '</div>');
                            } else {
                                $("#infoAlert").html('');
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error("Search failed:", error);
                            $("#infoAlert").html('<div class="alert alert-danger alert-dismissible fade show">' +
                                '<i class="bi bi-exclamation-triangle"></i> An error occurred while loading attendance records.' +
                                '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                                '</div>');
                        }
                    });
                } else {
                    $("#infoAlert").html('<div class="alert alert-warning alert-dismissible fade show">' +
                        '<i class="bi bi-exclamation-triangle"></i> Please select a country.' +
                        '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                        '</div>');
                }
            }

            function formatTime(timeString) {
                if (!timeString) return '<span class="text-muted">-</span>';
                const parts = timeString.split(':');
                if (parts.length < 2) return timeString;
                let hours = parseInt(parts[0]);
                const minutes = parts[1];
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12;
                return hours + ':' + minutes + ' ' + ampm;
            }

            $("#searchForm").submit(function (e) {
                e.preventDefault();
                filter();
            });

            $("#searchBtn").click(function () {
                filter();
            });

            $("#clearBtn").click(function() {
                $("#searchTerm").val('');
                $("#branchFilter").val('');
                $("#departmentFilter").val('');
                $("#employeeTypeFilter").val('');
                $("#jobTitleFilter").val('');
            });

            $("#countryFilter, #branchFilter, #departmentFilter, #employeeTypeFilter, #jobTitleFilter").change(function () {
                if (selectedDate && $("#countryFilter").val()) {
                    filter();
                }
            });

            function fillTable(response) {
                var tableBody = $("#attendanceRecords");
                tableBody.empty();

                if (response && response.length > 0) {
                    var newRows = "";
                    var rowNumber = 1;
                    
                    response.forEach(function (attendanceRecord) {
                        var statusBadge = '';
                        var statusClass = attendanceRecord.status || 'Unknown';
                        
                        switch(statusClass.toLowerCase()) {
                            case 'present':
                                statusBadge = '<span class="badge bg-success fs-6"><i class="bi bi-check-circle"></i> Present</span>';
                                break;
                            case 'absent':
                                statusBadge = '<span class="badge bg-danger fs-6"><i class="bi bi-x-circle"></i> Absent</span>';
                                break;
                            case 'late':
                                statusBadge = '<span class="badge bg-warning text-dark fs-6"><i class="bi bi-clock-history"></i> Late</span>';
                                break;
                            case 'on leave':
                                statusBadge = '<span class="badge bg-info fs-6"><i class="bi bi-calendar-x"></i> On Leave</span>';
                                break;
                            default:
                                statusBadge = '<span class="badge bg-secondary fs-6">' + statusClass + '</span>';
                        }

                        newRows += '<tr>' +
                                        '<td class="text-center fw-bold text-muted">' + (rowNumber++) + '</td>' +
                                        '<td><strong>' + (attendanceRecord.fullName || '-') + '</strong></td>' +
                                        '<td><span class="badge bg-light text-dark">' + (attendanceRecord.branch || '-') + '</span></td>' +
                                        '<td><span class="badge bg-light text-dark">' + (attendanceRecord.department || '-') + '</span></td>' +
                                        '<td><span class="badge bg-light text-dark">' + (attendanceRecord.type || '-') + '</span></td>' +
                                        '<td><span class="badge bg-light text-dark">' + (attendanceRecord.jobTitle || '-') + '</span></td>' +
                                        '<td class="text-center">' + statusBadge + '</td>' +
                                        '<td class="text-center"><span class="badge bg-primary fs-6">' + formatTime(attendanceRecord.checkInTime) + '</span></td>' +
                                        '<td class="text-center"><span class="badge bg-warning text-dark fs-6">' + formatTime(attendanceRecord.checkOutTime) + '</span></td>' +
                                        '<td class="text-center"><span class="badge bg-info fs-6">' + (attendanceRecord.totalHours || '0') + ' hrs</span></td>' +
                                        '<td class="text-center"><span class="badge bg-success fs-6">' + (attendanceRecord.overTimeHours || '0') + ' hrs</span></td>' +
                                        '<td><small class="text-muted">' + (attendanceRecord.notes || '-') + '</small></td>' +
                                    '</tr>';
                    });
                    tableBody.html(newRows);
                    
                    // Update record count
                    $('#recordCount').text(response.length + ' Record' + (response.length !== 1 ? 's' : ''));
                    $('#exportBtn').prop('disabled', false);
                } else {
                    var noResultsRow = '<tr>' +
                        '<td colspan="12" class="text-center text-muted py-5">' +
                            '<i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.5;"></i>' +
                            '<p class="mt-3 mb-0 fs-5">No attendance records found</p>' +
                            '<p class="text-muted"><small>Try adjusting your filters or selecting a different date</small></p>' +
                        '</td>' +
                    '</tr>';
                    tableBody.html(noResultsRow);
                    
                    // Update record count
                    $('#recordCount').text('0 Records');
                    $('#exportBtn').prop('disabled', true);
                }
            }

            // Export functionality
            $('#exportBtn').click(function() {
                exportToExcel();
            });

            function exportToExcel() {
                // Get the selected date for filename
                const dateForFilename = selectedDate ? selectedDate.replace(/-/g, '') : 'attendance';
                const filename = 'Attendance_Report_' + dateForFilename + '.xls';

                // Get the table data
                const tableData = [];
                const headers = [];
                
                // Get headers
                $('#attendanceRecords').closest('table').find('thead th').each(function() {
                    const headerText = $(this).text().trim();
                    headers.push(headerText);
                });
                tableData.push(headers);

                // Get data rows
                $('#attendanceRecords tr').each(function() {
                    const row = [];
                    $(this).find('td').each(function() {
                        // Get text content, removing extra whitespace and icons
                        let cellText = $(this).text().trim();
                        // Remove "hrs" suffix if present
                        cellText = cellText.replace(/\s*hrs\s*$/i, '');
                        row.push(cellText);
                    });
                    
                    // Only add rows that have data (not the "no records" message)
                    if (row.length > 0 && row[0] !== '' && !$(this).find('td[colspan]').length) {
                        tableData.push(row);
                    }
                });

                // Check if there's data to export
                if (tableData.length <= 1) {
                    alert('No data to export. Please load attendance records first.');
                    return;
                }

                // Create Excel content
                let excelContent = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">';
                excelContent += '<head>';
                excelContent += '<meta charset="UTF-8">';
                excelContent += '<!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet>';
                excelContent += '<x:Name>Attendance Report</x:Name>';
                excelContent += '<x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet>';
                excelContent += '</x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]-->';
                excelContent += '<style>';
                excelContent += 'table { border-collapse: collapse; width: 100%; }';
                excelContent += 'th { background-color: #0d6efd; color: white; font-weight: bold; padding: 10px; border: 1px solid #ddd; text-align: left; }';
                excelContent += 'td { padding: 8px; border: 1px solid #ddd; }';
                excelContent += 'tr:nth-child(even) { background-color: #f9f9f9; }';
                excelContent += '.text-center { text-align: center; }';
                excelContent += '</style>';
                excelContent += '</head>';
                excelContent += '<body>';
                
                // Add report header
                const reportDate = selectedDate ? new Date(selectedDate + 'T00:00:00').toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                }) : 'N/A';
                
                const countryName = $('#countryFilter option:selected').text() || 'All Countries';
                
                excelContent += '<h2>Attendance Report</h2>';
                excelContent += '<p><strong>Date:</strong> ' + reportDate + '</p>';
                excelContent += '<p><strong>Country:</strong> ' + countryName + '</p>';
                excelContent += '<p><strong>Generated:</strong> ' + new Date().toLocaleString() + '</p>';
                excelContent += '<p><strong>Total Records:</strong> ' + (tableData.length - 1) + '</p>';
                excelContent += '<br/>';
                
                // Add table
                excelContent += '<table>';
                
                // Add table data
                tableData.forEach(function(row, index) {
                    excelContent += '<tr>';
                    row.forEach(function(cell) {
                        if (index === 0) {
                            excelContent += '<th>' + cell + '</th>';
                        } else {
                            excelContent += '<td>' + cell + '</td>';
                        }
                    });
                    excelContent += '</tr>';
                });
                
                excelContent += '</table></body></html>';

                // Create Blob and download
                const blob = new Blob([excelContent], {
                    type: 'application/vnd.ms-excel;charset=utf-8;'
                });

                // Create download link
                if (navigator.msSaveBlob) { // IE 10+
                    navigator.msSaveBlob(blob, filename);
                } else {
                    const link = document.createElement('a');
                    if (link.download !== undefined) {
                        // Browsers that support HTML5 download attribute
                        const url = URL.createObjectURL(blob);
                        link.setAttribute('href', url);
                        link.setAttribute('download', filename);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        // Show success message
                        $("#infoAlert").html('<div class="alert alert-success alert-dismissible fade show">' +
                            '<i class="bi bi-check-circle"></i> Attendance report exported successfully as "' + filename + '"' +
                            '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                            '</div>');
                        
                        // Auto-dismiss after 3 seconds
                        setTimeout(function() {
                            $("#infoAlert .alert").fadeOut();
                        }, 3000);
                    }
                }
            }
        });
    </script>

    <style>
        /* Calendar Styling */
        #calendar {
            max-width: 100%;
            margin: 0 auto;
            font-size: 0.95rem;
        }

        /* Selected date styling */
        .fc-day-selected {
            background-color: #0d6efd !important;
            border: 3px solid #0a58ca !important;
            position: relative;
        }

        .fc-day-selected .fc-daygrid-day-number {
            color: white !important;
            font-weight: bold !important;
            font-size: 1.2em !important;
        }

        /* Today styling (different from selected) */
        .fc-day-today-custom {
            background-color: #fff3cd !important;
        }

        .fc-day-today {
            background-color: transparent !important;
        }

        /* Hover effect */
        .fc-day:hover {
            background-color: #e7f3ff !important;
            cursor: pointer;
            transform: scale(1.02);
            transition: all 0.2s ease;
        }

        .fc-day-selected:hover {
            background-color: #0d6efd !important;
        }

        /* Calendar header styling */
        .fc .fc-toolbar-title {
            font-size: 1.5em !important;
            font-weight: 600 !important;
            color: #212529;
        }

        .fc .fc-button {
            background-color: #0d6efd !important;
            border-color: #0d6efd !important;
            text-transform: capitalize !important;
            padding: 8px 15px !important;
            font-size: 1rem !important;
        }

        .fc .fc-button:hover {
            background-color: #0b5ed7 !important;
            border-color: #0a58ca !important;
        }

        .fc .fc-button:disabled {
            opacity: 0.5;
        }

        /* Day numbers */
        .fc-daygrid-day-number {
            padding: 10px;
            font-weight: 500;
            font-size: 1.1em;
        }

        /* Weekend styling */
        .fc-day-sat, .fc-day-sun {
            background-color: #f8f9fa;
        }

        /* Selected date display box */
        #selectedDateDisplay {
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-left: 4px solid #0d6efd;
            padding-left: 15px;
        }

        /* Table enhancements */
        .table-hover tbody tr:hover {
            background-color: #f0f8ff !important;
            cursor: pointer;
        }

        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(0, 0, 0, 0.02);
        }

        /* Badge styling */
        .badge {
            font-weight: 500;
            padding: 6px 12px;
        }

        /* Card shadow enhancement */
        .card.shadow {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
        }

        /* Responsive calendar */
        @@media (max-width: 768px) {
            .fc .fc-toolbar {
                flex-direction: column;
                gap: 10px;
            }
            
            .fc .fc-toolbar-chunk {
                margin: 5px 0;
            }

            .fc .fc-toolbar-title {
                font-size: 1.2em !important;
            }

            .fc-daygrid-day-number {
                font-size: 0.9em;
                padding: 6px;
            }
        }

        /* Smooth transitions */
        .card {
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        /* Export button */
        #exportBtn:not(:disabled):hover {
            transform: scale(1.05);
            transition: transform 0.2s ease;
        }
    </style>
}