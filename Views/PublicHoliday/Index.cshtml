@model PublicHolidayIndexVM

@{
    ViewData["Title"] = "Public Holidays";
}

<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@@6.1.10/index.global.min.css' rel='stylesheet' />

<div class="container-fluid mt-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="bi bi-calendar-event"></i> Public Holidays</h2>
                    <p class="text-muted">Manage public holidays and non-working days</p>
                </div>
                <div>
                    <a asp-action="Create" class="btn btn-primary btn-lg">
                        <i class="bi bi-plus-circle"></i> Add Public Holiday
                    </a>
                </div>
            </div>
            <hr />
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-calendar-event"></i> Total Holidays</h6>
                    <h2 class="mb-0">@Model.PublicHolidays.Count()</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-calendar-check"></i> This Year</h6>
                    <h2 class="mb-0">@Model.PublicHolidays.Count(h => h.Date.Year == DateTime.Now.Year)</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-globe"></i> Countries</h6>
                    <h2 class="mb-0">@Model.Countries.Count()</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> Filters & Search</h5>
        </div>
        <div class="card-body">
            <form id="searchForm">
                @Html.AntiForgeryToken()
                <div class="row">
                    <div class="col-md-5">
                        <label for="countryFilter" class="form-label">
                            <i class="bi bi-globe"></i> Filter by Country
                        </label>
                        <select id="countryFilter" class="form-select form-select-lg" 
                                asp-items="@(new SelectList(Model.Countries, "Id", "Name"))">
                            <option value="">All Countries</option>
                        </select>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label">
                            <i class="bi bi-search"></i> Search Holiday
                        </label>
                        <input type="text" id="searchTerm" class="form-control form-control-lg" 
                               placeholder="Search by holiday name..." />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label d-block">&nbsp;</label>
                        <button type="button" id="clearBtn" class="btn btn-secondary btn-lg w-100">
                            <i class="bi bi-x-circle"></i> Clear
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Calendar View -->
    <div class="card">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-calendar3"></i> Holiday Calendar</h5>
        </div>
        <div class="card-body">
            <div id="calendar"></div>
        </div>
        <div class="card-footer">
            <div class="d-flex justify-content-center gap-4 flex-wrap">
                <div class="legend-item">
                    <span class="legend-box bg-danger"></span>
                    <span>National Holidays</span>
                </div>
                <div class="legend-item">
                    <span class="legend-box bg-primary"></span>
                    <span>Religious Holidays</span>
                </div>
                <div class="legend-item">
                    <span class="legend-box bg-success"></span>
                    <span>Cultural Events</span>
                </div>
                <div class="legend-item">
                    <span class="legend-box bg-warning"></span>
                    <span>Other Holidays</span>
                </div>
            </div>
        </div>
    </div>

    @if (!Model.PublicHolidays.Any())
    {
        <div class="alert alert-info mt-4">
            <i class="bi bi-info-circle"></i> No public holidays found. Click "Add Public Holiday" to get started.
        </div>
    }
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <!-- FullCalendar JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@@6.1.10/index.global.min.js'></script>

    <script>
        $(document).ready(function () {
            let calendar = null;
            let allHolidays = @Html.Raw(Json.Serialize(Model.PublicHolidays.Select(h => new {
                id = h.Id,
                title = h.Name,
                date = h.Date.ToString("yyyy-MM-dd"),
                country = h.Country.Name,
                countryId = h.CountryId
            })));

            // Get holiday color based on name/type
            function getHolidayColor(name) {
                name = name.toLowerCase();
                if (name.includes('national') || name.includes('independence') || name.includes('revolution')) {
                    return '#dc3545'; // Red for national holidays
                } else if (name.includes('eid') || name.includes('ramadan') || name.includes('christmas') || name.includes('easter')) {
                    return '#0d6efd'; // Blue for religious holidays
                } else if (name.includes('labor') || name.includes('workers') || name.includes('culture')) {
                    return '#198754'; // Green for cultural/labor events
                } else {
                    return '#ffc107'; // Yellow for other holidays
                }
            }

            // Initialize FullCalendar
            function initCalendar(holidays) {
                if (calendar) {
                    calendar.destroy();
                }

                var calendarEl = document.getElementById('calendar');
                
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,dayGridWeek,listYear'
                    },
                    height: 'auto',
                    events: holidays.map(function(holiday) {
                        return {
                            id: holiday.id,
                            title: holiday.title,
                            start: holiday.date,
                            allDay: true,
                            backgroundColor: getHolidayColor(holiday.title),
                            borderColor: getHolidayColor(holiday.title),
                            extendedProps: {
                                country: holiday.country,
                                countryId: holiday.countryId
                            }
                        };
                    }),
                    eventClick: function(info) {
                        showHolidayDetails(info.event);
                    },
                    eventContent: function(arg) {
                        return {
                            html: '<div class="fc-event-main-frame"><div class="fc-event-title-container"><div class="fc-event-title fc-sticky"><strong>' + arg.event.title + '</strong></div></div></div>'
                        };
                    }
                });
                
                calendar.render();
            }

            // Show holiday details in modal
            function showHolidayDetails(event) {
                var eventDate = new Date(event.start);
                var formattedDate = eventDate.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                var modalHtml = '<div class="modal fade" id="holidayDetailModal" tabindex="-1">' +
                    '<div class="modal-dialog modal-dialog-centered">' +
                    '<div class="modal-content">' +
                    '<div class="modal-header text-white" style="background-color: ' + event.backgroundColor + ';">' +
                    '<h5 class="modal-title"><i class="bi bi-calendar-event me-2"></i>' + event.title + '</h5>' +
                    '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>' +
                    '</div>' +
                    '<div class="modal-body">' +
                    '<div class="mb-3"><strong><i class="bi bi-calendar3 me-2"></i>Date:</strong> ' + formattedDate + '</div>' +
                    '<div class="mb-3"><strong><i class="bi bi-globe me-2"></i>Country:</strong> <span class="badge bg-primary">' + event.extendedProps.country + '</span></div>' +
                    '</div>' +
                    '<div class="modal-footer">' +
                    '<a href="/PublicHoliday/Edit/' + event.id + '" class="btn btn-warning"><i class="bi bi-pencil me-1"></i>Edit</a>' +
                    '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>' +
                    '</div>' +
                    '</div></div></div>';

                $('#holidayDetailModal').remove();
                $('body').append(modalHtml);
                var modal = new bootstrap.Modal(document.getElementById('holidayDetailModal'));
                modal.show();
                
                $('#holidayDetailModal').on('hidden.bs.modal', function() {
                    $(this).remove();
                });
            }

            // Filter functionality
            function filterHolidays() {
                var searchTerm = $("#searchTerm").val().toLowerCase();
                var countryId = parseInt($("#countryFilter").val()) || 0;

                var filteredHolidays = allHolidays.filter(function(holiday) {
                    var matchesSearch = searchTerm === '' || holiday.title.toLowerCase().includes(searchTerm);
                    var matchesCountry = countryId === 0 || holiday.countryId === countryId;
                    return matchesSearch && matchesCountry;
                });

                initCalendar(filteredHolidays);
            }

            $("#searchTerm").on('input', function() {
                filterHolidays();
            });

            $("#countryFilter").change(function () {
                filterHolidays();
            });

            $("#clearBtn").click(function() {
                $("#searchTerm").val('');
                $("#countryFilter").val('');
                filterHolidays();
            });

            // Initialize calendar on page load
            initCalendar(allHolidays);
        });
    </script>

    <style>
        /* Calendar styling */
        #calendar {
            max-width: 100%;
            margin: 0 auto;
            font-size: 0.95rem;
        }

        /* Blue navigation buttons */
        .fc .fc-button {
            background-color: #0d6efd !important;
            border-color: #0d6efd !important;
            color: white !important;
        }

        .fc .fc-button:hover {
            background-color: #0b5ed7 !important;
            border-color: #0a58ca !important;
        }

        .fc .fc-button:disabled {
            background-color: #6c757d !important;
            border-color: #6c757d !important;
            opacity: 0.65;
        }

        .fc .fc-button-primary:not(:disabled):active,
        .fc .fc-button-primary:not(:disabled).fc-button-active {
            background-color: #0a58ca !important;
            border-color: #0a53be !important;
        }

        .fc-event {
            cursor: pointer;
            border-radius: 3px;
            padding: 2px 4px;
            font-weight: 600;
            border: 2px solid;
        }

        .fc-event:hover {
            opacity: 0.85;
            transform: scale(1.05);
            transition: all 0.2s ease;
        }

        .fc .fc-daygrid-day.fc-day-today {
            background-color: #fff3cd !important;
        }

        .fc-daygrid-day-frame {
            min-height: 100px;
        }

        /* Legend styling */
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .legend-box {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: inline-block;
            border: 2px solid #dee2e6;
        }

        /* Responsive */
        @@media (max-width: 768px) {
            .fc .fc-toolbar {
                flex-direction: column;
                gap: 10px;
            }
            
            .fc .fc-toolbar-chunk {
                margin: 5px 0;
            }

            .fc .fc-toolbar-title {
                font-size: 1.2em !important;
            }
        }
    </style>
}