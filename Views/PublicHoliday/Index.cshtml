@model PublicHolidayIndexVM

@{
    ViewData["Title"] = "Public Holidays";
}

<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@@6.1.10/index.global.min.css' rel='stylesheet' />

<div class="page-section">

    <!-- Header -->
    <div class="bp-header">
        <h1><i class="bi bi-calendar-event"></i> Public Holidays</h1>
        <p>Manage public holidays and non-working days</p>
    </div>

    <div class = " list-page" >
        <!-- Floating Add Button -->
        <a href="javascript:void(0)" 
           onclick="openModalWithAjax('@Url.Action("Create", "PublicHoliday")', 'Add Public Holiday')" 
           class="floating-btn" 
           title="Add Public Holiday">
           <i class="fa-solid fa-plus"></i>
        </a>

    </div>
    <!-- Stats Row -->
    <div class="bp-stats-row">
        <div class="bp-stat-card stat-1">
            <div>
                <h3>@Model.PublicHolidays.Count()</h3>
                <p>Total Holidays</p>
            </div>
            <i class="bi bi-calendar-event"></i>
        </div>

        <div class="bp-stat-card stat-2">
            <div>
                <h3>@Model.PublicHolidays.Count(h => h.Date.Year == DateTime.Now.Year)</h3>
                <p>This Year</p>
            </div>
            <i class="bi bi-calendar-check"></i>
        </div>

        <div class="bp-stat-card stat-3">
            <div>
                <h3>@Model.Countries.Count()</h3>
                <p>Countries</p>
            </div>
            <i class="bi bi-globe"></i>
        </div>
    </div>
    <br>
    <!-- Search & Filter Card -->
    <div class="bp-search-card shadow-sm border-0 mb-4">
        <div class="card-body p-3">
            <form id="searchForm" class="bp-search-form row g-3 align-items-end">
                @Html.AntiForgeryToken()

                <!-- Country Filter -->
                <div class="col-md-3">
                    <label class="form-label small text-muted">
                        <i class="bi bi-globe"></i> Filter by Country
                    </label>
                    <select id="countryFilter" class="form-select bp-filter-select" 
                            asp-items="@(new SelectList(Model.Countries, "Id", "Name"))">
                        <option value="">All Countries</option>
                    </select>
                </div>

                <!-- Search -->
                <div class="col-md-5">
                    <label class="form-label small text-muted">
                        <i class="bi bi-search"></i> Search Holiday
                    </label>
                    <div class="bp-search-group">
                        <i class="bi bi-search"></i>
                        <input type="text" id="searchTerm" placeholder="Search by holiday name..." />
                    </div>
                </div>

                <!-- Clear Button -->
                <div class="col-md-2">
                    <button type="button" id="clearBtn" class="btn bp-btn-filter w-100">
                        <i class="bi bi-x-circle me-2"></i> Clear
                    </button>
                </div>

            </form>
        </div>
    </div>

 <!-- Calendar View -->
<div class="card bp-calendar-card shadow-sm border-0">
    <div class="card-header bp-calendar-header">
        <h4 class="mb-0"><i class="bi bi-calendar3"></i> Holiday Calendar</h4>
    </div>
    <div class="card-body bp-calendar-body">
        <div id="calendar"></div>
    </div>
    <div class="card-footer bp-calendar-footer">
        <div class="d-flex justify-content-center gap-4 flex-wrap">
            <div class="legend-item">
                <span class="legend-box bg-danger"></span>
                <span>National Holidays</span>
            </div>
            <div class="legend-item">
                <span class="legend-box bg-primary"></span>
                <span>Religious Holidays</span>
            </div>
            <div class="legend-item">
                <span class="legend-box bg-success"></span>
                <span>Cultural Events</span>
            </div>
            <div class="legend-item">
                <span class="legend-box bg-warning"></span>
                <span>Other Holidays</span>
            </div>
        </div>
    </div>
</div>


    @if (!Model.PublicHolidays.Any())
    {
        <div class="alert alert-info mt-4">
            <i class="bi bi-info-circle"></i> No public holidays found. Click "Add Public Holiday" to get started.
        </div>
    }
</div>
<link rel="stylesheet" href="~/css/ListPageHeader.css" />
<link rel="stylesheet" href="~/css/Calendar.css" />
<link rel="stylesheet" href="~/css/CRUD/Index.css" />
@await Html.PartialAsync("_GeneralModal")
@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <!-- FullCalendar JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@@6.1.10/index.global.min.js'></script>

    <script>
        $(document).ready(function () {
            let calendar = null;
            let allHolidays = @Html.Raw(Json.Serialize(Model.PublicHolidays.Select(h => new {
                id = h.Id,
                title = h.Name,
                date = h.Date.ToString("yyyy-MM-dd"),
                country = h.Country.Name,
                countryId = h.CountryId
            })));

            // Get holiday color based on name/type
            function getHolidayColor(name) {
                name = name.toLowerCase();
                if (name.includes('national') || name.includes('independence') || name.includes('revolution')) {
                    return '#dc3545'; // Red for national holidays
                } else if (name.includes('eid') || name.includes('ramadan') || name.includes('christmas') || name.includes('easter')) {
                    return '#0d6efd'; // Blue for religious holidays
                } else if (name.includes('labor') || name.includes('workers') || name.includes('culture')) {
                    return '#198754'; // Green for cultural/labor events
                } else {
                    return '#ffc107'; // Yellow for other holidays
                }
            }

            // Initialize FullCalendar
            function initCalendar(holidays) {
                if (calendar) {
                    calendar.destroy();
                }

                var calendarEl = document.getElementById('calendar');
                
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,dayGridWeek,listYear'
                    },
                    height: 'auto',
                    events: holidays.map(function(holiday) {
                        return {
                            id: holiday.id,
                            title: holiday.title,
                            start: holiday.date,
                            allDay: true,
                            backgroundColor: getHolidayColor(holiday.title),
                            borderColor: getHolidayColor(holiday.title),
                            extendedProps: {
                                country: holiday.country,
                                countryId: holiday.countryId
                            }
                        };
                    }),
                    eventClick: function(info) {
                        showHolidayDetails(info.event);
                    },
                    eventContent: function(arg) {
                        return {
                            html: '<div class="fc-event-main-frame"><div class="fc-event-title-container"><div class="fc-event-title fc-sticky"><strong>' + arg.event.title + '</strong></div></div></div>'
                        };
                    }
                });
                
                calendar.render();
            }

            // Show holiday details in modal
            function showHolidayDetails(event) {
                var eventDate = new Date(event.start);
                var formattedDate = eventDate.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                var modalHtml = '<div class="modal fade" id="holidayDetailModal" tabindex="-1">' +
                    '<div class="modal-dialog modal-dialog-centered">' +
                    '<div class="modal-content">' +
                    '<div class="modal-header text-white" style="background-color: ' + event.backgroundColor + ';">' +
                    '<h5 class="modal-title"><i class="bi bi-calendar-event me-2"></i>' + event.title + '</h5>' +
                    '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>' +
                    '</div>' +
                    '<div class="modal-body">' +
                    '<div class="mb-3"><strong><i class="bi bi-calendar3 me-2"></i>Date:</strong> ' + formattedDate + '</div>' +
                    '<div class="mb-3"><strong><i class="bi bi-globe me-2"></i>Country:</strong> <span class="badge bg-primary">' + event.extendedProps.country + '</span></div>' +
                    '</div>' +
                    '<div class="modal-footer">' +
                    '<a href="/PublicHoliday/Edit/' + event.id + '" class="btn btn-warning"><i class="bi bi-pencil me-1"></i>Edit</a>' +
                    '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>' +
                    '</div>' +
                    '</div></div></div>';

                $('#holidayDetailModal').remove();
                $('body').append(modalHtml);
                var modal = new bootstrap.Modal(document.getElementById('holidayDetailModal'));
                modal.show();
                
                $('#holidayDetailModal').on('hidden.bs.modal', function() {
                    $(this).remove();
                });
            }

            // Filter functionality
            function filterHolidays() {
                var searchTerm = $("#searchTerm").val().toLowerCase();
                var countryId = parseInt($("#countryFilter").val()) || 0;

                var filteredHolidays = allHolidays.filter(function(holiday) {
                    var matchesSearch = searchTerm === '' || holiday.title.toLowerCase().includes(searchTerm);
                    var matchesCountry = countryId === 0 || holiday.countryId === countryId;
                    return matchesSearch && matchesCountry;
                });

                initCalendar(filteredHolidays);
            }

            $("#searchTerm").on('input', function() {
                filterHolidays();
            });

            $("#countryFilter").change(function () {
                filterHolidays();
            });

            $("#clearBtn").click(function() {
                $("#searchTerm").val('');
                $("#countryFilter").val('');
                filterHolidays();
            });

            // Initialize calendar on page load
            initCalendar(allHolidays);
        });
    </script>

}