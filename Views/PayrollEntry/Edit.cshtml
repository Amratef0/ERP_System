@model PayrollEntryVM

@{
    ViewData["Title"] = "Edit Payroll Entry";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h2 class="mb-4">
                <i class="bi bi-pencil"></i> Edit Payroll Entry
            </h2>

            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle"></i> @TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            <!-- Employee Info Header -->
            <div class="alert alert-info">
                <h5><i class="bi bi-person-badge"></i> @Model.EmployeeName</h5>
                <p class="mb-0">
                    <strong>Payroll Run:</strong> @Model.PayrollRunName<br>
                    <strong>Department:</strong> @Model.DepartmentName | <strong>Job Title:</strong> @Model.JobTitleName
                </p>
            </div>

            <form asp-action="Edit" method="post">
                @Html.AntiForgeryToken()
                @Html.HiddenFor(m => m.Id)
                @Html.HiddenFor(m => m.PayrollRunId)
                @Html.HiddenFor(m => m.EmployeeId)
                @Html.HiddenFor(m => m.CurrencyId)

                <div class="card shadow mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Earnings</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="BaseSalaryAmount" class="form-label"></label>
                                <div class="input-group">
                                    <input asp-for="BaseSalaryAmount" class="form-control" />
                                    <span class="input-group-text">@Model.CurrencyCode</span>
                                </div>
                                <span asp-validation-for="BaseSalaryAmount" class="text-danger"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="OvertimeAmount" class="form-label"></label>
                                <div class="input-group">
                                    <input asp-for="OvertimeAmount" class="form-control" />
                                    <span class="input-group-text">@Model.CurrencyCode</span>
                                </div>
                                <span asp-validation-for="OvertimeAmount" class="text-danger"></span>
                                <small class="form-text text-muted">Calculated at 1.5x hourly rate</small>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="BonusAmount" class="form-label"></label>
                                <div class="input-group">
                                    <input asp-for="BonusAmount" class="form-control" />
                                    <span class="input-group-text">@Model.CurrencyCode</span>
                                </div>
                                <span asp-validation-for="BonusAmount" class="text-danger"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="AllowanceAmount" class="form-label"></label>
                                <div class="input-group">
                                    <input asp-for="AllowanceAmount" class="form-control" />
                                    <span class="input-group-text">@Model.CurrencyCode</span>
                                </div>
                                <span asp-validation-for="AllowanceAmount" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="alert alert-light mb-0">
                            <strong>Gross Salary:</strong> 
                            <span id="grossSalary" class="text-success fs-5 float-end">0.00 @Model.CurrencyCode</span>
                        </div>
                    </div>
                </div>

                <div class="card shadow mb-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="bi bi-dash-circle"></i> Deductions</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="DeductionAmount" class="form-label"></label>
                                <div class="input-group">
                                    <input asp-for="DeductionAmount" class="form-control" />
                                    <span class="input-group-text">@Model.CurrencyCode</span>
                                </div>
                                <span asp-validation-for="DeductionAmount" class="text-danger"></span>
                                <small class="form-text text-muted">Unpaid leave days</small>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="TaxAmount" class="form-label"></label>
                                <div class="input-group">
                                    <input asp-for="TaxAmount" class="form-control" />
                                    <span class="input-group-text">@Model.CurrencyCode</span>
                                </div>
                                <span asp-validation-for="TaxAmount" class="text-danger"></span>
                                <small class="form-text text-muted">10% of gross salary</small>
                            </div>
                        </div>

                        <div class="alert alert-light mb-0">
                            <strong>Total Deductions:</strong> 
                            <span id="totalDeductions" class="text-danger fs-5 float-end">0.00 @Model.CurrencyCode</span>
                        </div>
                    </div>
                </div>

                <div class="card shadow mb-4 border-primary">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="bi bi-cash-coin"></i> NET AMOUNT</h4>
                    </div>
                    <div class="card-body text-center">
                        <h1 class="display-5 text-primary mb-0">
                            <strong id="netAmount">0.00 @Model.CurrencyCode</strong>
                        </h1>
                    </div>
                </div>

                <div class="card shadow mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-info-circle"></i> Additional Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="PaymentDate" class="form-label"></label>
                                <input asp-for="PaymentDate" class="form-control" type="date" />
                                <span asp-validation-for="PaymentDate" class="text-danger"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="BankAccountNumber" class="form-label"></label>
                                <input asp-for="BankAccountNumber" class="form-control" />
                                <span asp-validation-for="BankAccountNumber" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-0">
                            <label asp-for="Notes" class="form-label"></label>
                            <textarea asp-for="Notes" class="form-control" rows="3" placeholder="Add any notes or comments..."></textarea>
                            <span asp-validation-for="Notes" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between">
                    <a asp-controller="PayrollRun" asp-action="Details" asp-route-id="@Model.PayrollRunId" class="btn btn-secondary">
                        <i class="bi bi-x-circle"></i> Cancel
                    </a>
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-check-circle"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        $(document).ready(function() {
            calculateTotals();

            // Auto-calculate tax when gross changes
            $('input[name="BaseSalaryAmount"], input[name="OvertimeAmount"], input[name="BonusAmount"], input[name="AllowanceAmount"]').on('input', function() {
                calculateTotals();
                calculateTax();
            });

            $('input[name="DeductionAmount"], input[name="TaxAmount"]').on('input', function() {
                calculateTotals();
            });

            function calculateTotals() {
                var base = parseFloat($('input[name="BaseSalaryAmount"]').val()) || 0;
                var overtime = parseFloat($('input[name="OvertimeAmount"]').val()) || 0;
                var bonus = parseFloat($('input[name="BonusAmount"]').val()) || 0;
                var allowance = parseFloat($('input[name="AllowanceAmount"]').val()) || 0;
                var deduction = parseFloat($('input[name="DeductionAmount"]').val()) || 0;
                var tax = parseFloat($('input[name="TaxAmount"]').val()) || 0;

                var gross = base + overtime + bonus + allowance;
                var totalDed = deduction + tax;
                var net = gross - totalDed;

                $('#grossSalary').text(gross.toFixed(2) + ' @Model.CurrencyCode');
                $('#totalDeductions').text(totalDed.toFixed(2) + ' @Model.CurrencyCode');
                $('#netAmount').text(net.toFixed(2) + ' @Model.CurrencyCode');
            }

            function calculateTax() {
                var base = parseFloat($('input[name="BaseSalaryAmount"]').val()) || 0;
                var overtime = parseFloat($('input[name="OvertimeAmount"]').val()) || 0;
                var bonus = parseFloat($('input[name="BonusAmount"]').val()) || 0;
                var allowance = parseFloat($('input[name="AllowanceAmount"]').val()) || 0;

                var gross = base + overtime + bonus + allowance;
                var tax = gross * 0.10;

                $('input[name="TaxAmount"]').val(tax.toFixed(4));
                calculateTotals();
            }
        });
    </script>
}
