@model AttendanceIndexVM

@{
    ViewData["Title"] = "Index";
}

<h1>Index</h1>

<div class="mb-3">
    <label for="countryFilter" class="form-label">Filter by Branch:</label>
    <select id="countryFilter" class="form-control" asp-items="@(new SelectList(Model.Countries, "Id", "Name"))">
        <option value="">-- Select Country --</option>
    </select>
</div>


<div class="mb-3">
    <label for="dateFilter" class="form-label">Select Date:</label>
    <input type="date" id="dateFilter" class="form-control" />
</div>


<div class="mb-3">
    <form id="searchForm">
        @Html.AntiForgeryToken()
        <div class="input-group">
            <input type="text" id="searchTerm" class="form-control" placeholder="Search by employee name..." />

            <button type="button" id="searchBtn" class="btn btn-primary">
                <i class="bi bi-search"></i> Search
            </button>
        </div>
    </form>
</div>

<div class="mb-3">
    <label for="branchFilter" class="form-label">Filter by Branch:</label>
    <select id="branchFilter" class="form-control" asp-items="@(new SelectList(Model.Branches, "Id", "Name"))">
        <option value="">-- Select Branch --</option>
    </select>
</div>

<div class="mb-3">
    <label for="departmentFilter" class="form-label">Filter by Department:</label>
    <select id="departmentFilter" class="form-control" asp-items="@(new SelectList(Model.Departments, "Id", "Name"))">
        <option value="">-- Select Department --</option>
    </select>
</div>

<div class="mb-3">
    <label for="employeeTypeFilter" class="form-label">Filter by Employee Type:</label>
    <select id="employeeTypeFilter" class="form-control" asp-items="@(new SelectList(Model.EmployeeTypes, "Id", "Name"))">
        <option value="">-- Select Employee Type --</option>
    </select>
</div>

<div class="mb-3">
    <label for="jobTitleFilter" class="form-label">Filter by Job Title:</label>
    <select id="jobTitleFilter" class="form-control" asp-items="@(new SelectList(Model.JobTitles, "Id", "Name"))">
        <option value="">-- Select Job Title --</option>
    </select>
</div>


<table class="table">
    <thead>
        <tr>
            <th>
                Full Name
            </th>
            <th>
                Branch
            </th>
            <th>
                Department
            </th>
            <th>
                Type
            </th>
            <th>
                Job Title
            </th>
            <th>
                Check In Time
            </th>
            <th>
                Check Out Time
            </th>
            <th>
                Total Hours
            </th>
            <th>
                OverTime Hours
            </th>
            <th>
                Notes
            </th>
        </tr>
    </thead>
    <tbody id="attendanceRecords">
    
    </tbody>
</table>


@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        $(document).ready(function () {
            function filter() {
                var date = $("#dateFilter").val();
                var searchTerm = $("#searchTerm").val();
				var country = parseInt($("#countryFilter").val()) || 0;
                var branch = parseInt($("#branchFilter").val()) || 0;
                var department = parseInt($("#departmentFilter").val()) || 0;
                var employeeType = parseInt($("#employeeTypeFilter").val()) || 0;
                var jobTitle = parseInt($("#jobTitleFilter").val()) || 0;

                var token = $('input[name="__RequestVerificationToken"]').val();

                if (date && country > 0) {
                    $.ajax({
                        type: "POST",
                        url: '@Url.Action("GetAttendance", "Attendance")',
                        data: {
                            date: date,
                            name: searchTerm,
                            countryId: country,
                            branchId: branch,
                            departmentId: department,
                            typeId: employeeType,
                            jobTitleId: jobTitle,
                            __RequestVerificationToken: token
                        },
                        success: function (response) {
                            fillTable(response.attendanceRecords);
                            if (response.infoMessage) {
                                $(".alert-info").remove();
                                $("table").before(`<div class="alert alert-info">${response.infoMessage}</div>`);
                            } else {
                                $(".alert-info").remove();
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error("Search failed:", error);
                            alert("An error occurred while searching.");
                        }
                    });
                } else {
                    if (!date) {
                        alert("Please select a date.");
                    } else if (country === 0) {
                        alert("Please select a country.");
                    }
                }

            }

            function formatTime(timeString) {
                if (!timeString) return '';

                const parts = timeString.split(':');
                if (parts.length < 2) return timeString;

                let hours = parseInt(parts[0]);
                const minutes = parts[1];
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12; // 0 → 12
                return `${hours}:${minutes} ${ampm}`;
            }


            $("#searchForm").submit(function (e) {
                e.preventDefault();
                filter();
            });

            $("#searchBtn").click(function () {
                filter();
            });

            $("#dateFilter").change(function () {
                filter();
            });

            $("#countryFilter").change(function () {
                filter();
            });

            $("#branchFilter").change(function () {
                filter();
            });

            $("#departmentFilter").change(function () {
                filter();
            });

            $("#employeeTypeFilter").change(function () {
                filter();
            });

            $("#jobTitleFilter").change(function () {
                filter();
            });

            function fillTable(response) {
                var tableBody = $("#attendanceRecords");
                tableBody.empty();

                if (response && response.length > 0) {
                    var newRows = "";
                    var token = $('input[name="__RequestVerificationToken"]').val();
                    response.forEach(function (attendanceRecord) {

                        newRows += `<tr>
                                        <td>${attendanceRecord.fullName}</td>
                                        <td>${attendanceRecord.branch}</td>
                                        <td>${attendanceRecord.department}</td>
                                        <td>${attendanceRecord.type}</td>
                                        <td>${attendanceRecord.jobTitle}</td>
                                        <td>${formatTime(attendanceRecord.checkInTime)}</td>
                                        <td>${formatTime(attendanceRecord.checkOutTime)}</td>
                                        <td>${attendanceRecord.totalHours}</td>
                                        <td>${attendanceRecord.overTimeHours}</td>
										<td>${attendanceRecord.notes || ''}</td>
                                    </tr>`;
                    });
                    tableBody.html(newRows);
                } else {
                    var noResultsRow = "<tr><td colspan='9' class='text-center'>No results found.</td></tr>";
                    tableBody.html(noResultsRow);
                }
            }
        });
    </script>
}